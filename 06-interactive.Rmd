# Interactive component

```{r}
library(dplyr)
library(tidyverse)
Calculate_Basis <- function(perp,future,s) {

  basis_df = merge(perp,future,by.x = "time", by.y= "time")
  
  basis_df$open = (basis_df$open.y - basis_df$open.x)/basis_df$open.x * 100
  basis_df$low = (basis_df$low.y - basis_df$low.x)/basis_df$low.x * 100
  basis_df$high = (basis_df$high.y - basis_df$high.x)/basis_df$high.x * 100
  basis_df$close = (basis_df$close.y - basis_df$close.x)/basis_df$close.x * 100
  basis_df$date = as.Date(basis_df$time)
  basis_df <- basis_df[, c('date', 'open','close','low','high')]
  
  basis_df = basis_df%>%
  group_by(date) %>%
  summarise_all(list(min,max,first,last))
  
  basis_df <- basis_df[, c('date', 'open_fn4','close_fn3','low_fn1','high_fn2')]
  names(basis_df)[2] <- 'open'
  names(basis_df)[3] <- 'close'
  names(basis_df)[4] <- 'low'
  names(basis_df)[5] <- 'high'
  return (basis_df)
}
```

```{r}
df <- read.csv('./edav_onchaindata/BTC-USDT.csv')
df$date = df$time
btc_perp = df


library(hash)
future_dir = './edav_onchaindata/future-swap'

names = list.files(future_dir)

futures <- hash()



for(name in names){
  
  future_path = paste(future_dir,name,sep='/')
  future <- read.csv(future_path)
  future$price = (future$high + future$low +future$close)/3
  future$date = future$time
  basis_s = merge(btc_perp,future,by.x = "time", by.y= "time")
  
  m = Calculate_Basis(btc_perp, future, name)
  last_row = nrow(m) - 2
  m <- m %>% slice( 3: last_row)
  futures[[substr(name, 10, 15)]] = m
}

delivery_times = c("2020-06-26", "2020-09-25", "2020-12-25", "2021-03-26", 
                  "2021-06-25", "2021-09-24", "2021-12-31", "2022-03-25")

delivery_times = as.Date(delivery_times)
keys = keys(futures)


```

```{R}
for (i in 1:8) {
  tem = futures[[keys[i]]]
  write_csv(tem,paste(format(delivery_times[i]),'_basis.csv'))
}
```


