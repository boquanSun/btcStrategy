# Results
```{r}
library(tidyverse)
library(knitr)
library(ggplot2)  
library(png) 
```

## How does the basis trading rate of return look like?

Basis trading rate of return mainly consists of two parts: earn/loss from funding rate, earn/loss from basis. 


Funding rate: as we mentioned in the introduction, funding rate is extremely important in the basis trading. The main idea of the basis trading is hedging, thus we have to open long positions and short positions at the same time.  We have to use the perpetual swap to add leverages, so the accumulation of funding rate with high leverage would be a large amount of money.

Basis: as we mentioned in the introduction, basis is the ratio of price difference between future swap and perpetual swap. It is calculated by (future swap price - perpetual swap price) / perpetual swap price.

When hedging, we open long basis positions or short basis positions. There, funding rates are unknown variables, but the basis is known. Long basis means we would lose money when basis is decreasing and earn money when funding rate is positive. When we have a short basis, we have to pay when the funding rate is positive but profit after the basis decreases. 

Look at how the basis and funding rate relate under different kinds of market conditions. We defined "BTC contract 210924" as bear market condition and "BTC contract 210326" as bull market.

### funding rate vs basis
```{r fig3, fig.width = 5, fig.asp = .9}

library(Rmisc)
df <- read.csv('./preprocess//bear_basis.csv')
df$date = as.Date(df$date)

df$re_funding = df$fundingRate*100
fd_label = seq(-0.3,0.5,0.1)
fd_label[4] = 0

df2 <-read.csv('./preprocess//bull_basis.csv')
df2$date = as.Date(df2$date)

df2$re_funding = df2$fundingRate*100



F1 <- ggplot(df) + 
  geom_col(aes(x = date, y = re_funding*30), size = 1, color = "red", fill = "red") +
  geom_line(aes(x = date, y = basis), size = 1.5, color="Black", group = 1) +
  ylab("% Basis")+ ggtitle("Bear Market") + 
  scale_y_continuous(sec.axis = sec_axis(~./30, name = "Funding Rate",
                                         breaks = fd_label,
                                           labels=paste(fd_label,"%",sep="")))  +
    theme(axis.line.y.right = element_line(color = "red"), 
        axis.ticks.y.right = element_line(color = "red"),
        axis.text.y.right = element_text(color = "red"), 
        axis.title.y.right = element_text(color = "red")
        ) +     geom_text(aes(x=as.Date("2021-04-01"),y=-2.5,label='Funding Rate'),color='red') +
    geom_text(aes(x=as.Date(as.Date("2021-04-01")),y=13,label='Basis'))

F2 <- ggplot(df2) + 
  geom_col(aes(x = date, y = re_funding*30), size = 1, color = "red", fill = "red") +
  geom_line(aes(x = date, y = basis), size = 1.5, color="Black", group = 1) +
  ylab("% Basis")+ ggtitle("Bull Market") + 
  scale_y_continuous(sec.axis = sec_axis(~./30, name = "Funding Rate",
                                         breaks = fd_label,labels=paste(fd_label,"%",sep=""))) +
  theme(axis.line.y.right = element_line(color = "red"), 
        axis.ticks.y.right = element_line(color = "red"),
        axis.text.y.right = element_text(color = "red"), 
        axis.title.y.right = element_text(color = "red")
        ) +
   geom_text(aes(x=as.Date("2021-01-01"),y=-1,label='Funding Rate'),color='red') +
    geom_text(aes(x=as.Date(as.Date("2020-12-01")),y=5,label='Basis'))
multiplot(F1, F2, cols = 1)
```


The higher funding rate accompanies a high basis. Also, as mentioned in the introduction, the value of basis is highly related to the remaining days of the contract. Even though the funding fee is extremely high at the tail of the contract, the basis would still gradually converge to zero. 


### accumulation of funding rate vs basis

The accumulation of funding rate is calculated as the sum of funding rate from today until the expiration date. It directly represents how much we have to pay/earn from the funding rate.
```{r}
df$re_ac_funding = df$accumulation_funding_rate*100
df2$re_ac_funding = df2$accumulation_funding_rate*100
F1 <- ggplot(df) + 
  geom_col(aes(x = date, y = re_ac_funding), size = 1, color = "red", fill = "red") +
  geom_line(aes(x = date, y = basis), size = 1.5, color="Black", group = 1) +
  ylab("% Basis")+ ggtitle("Bear Market") + 
  scale_y_continuous(sec.axis = sec_axis(~., name = "$ Accumulated Funding Rate")) +
  theme(axis.line.y.right = element_line(color = "red"), 
        axis.ticks.y.right = element_line(color = "red"),
        axis.text.y.right = element_text(color = "red"), 
        axis.title.y.right = element_text(color = "red")
        )

F2 <- ggplot(df2) + 
  geom_col(aes(x = date, y = re_ac_funding), size = 1, color = "red", fill = "red") +
  geom_line(aes(x = date, y = basis), size = 1.5, color="Black", group = 1) +
  ylab("% Basis")+ ggtitle("Bull Market") + 
  scale_y_continuous(sec.axis = sec_axis(~., name = "% Accumulated funding Rate"))+
  theme(axis.line.y.right = element_line(color = "red"), 
        axis.ticks.y.right = element_line(color = "red"),
        axis.text.y.right = element_text(color = "red"), 
        axis.title.y.right = element_text(color = "red")
        )

multiplot(F1, F2, cols = 1)
```
In a bull market, the accumulation of funding rate is never lower than the basis. If we keep a long position of the basis without leverage, the return would be calculated as ("accumulation_of_funding_rate" - "basis") / 2. Thus, in the bull market, long the basis would be a wise decision. However, the sudden drop of price would lead to serious loss. 



### Trading Return 
Plotting the the basis trading return: using 2*leverage to long the basis on bear market/bull market and holding until the contract expired.
```{r}
df$earned = df$accumulation_funding_rate*100 - df$basis
df2$earned = df2$accumulation_funding_rate*100 - df2$basis
F1 <- ggplot(df) + 
  geom_line(aes(x = date, y = earned), size = 1, color = "black") +
  ylab("% return")+ ggtitle("Basis Trading Return in Bear Market")


F2 <- ggplot(df2) + 
  geom_line(aes(x = date, y = earned), size = 1, color = "black") +
  ylab("% return")+ ggtitle("Basis Trading Return in Bull Market")
 

multiplot(F1, F2, cols = 1)
```

The return means if you long the position in that date, you will receive % return when the contract expired.

From the figures, we know that if we open the basis trading position randomly, the return highly depends on the market conditions. Because the maximum leverage in crypto market is 125, if we know the right time to enter the market, the basis trading will be very profitable.

The figures above tell us don't short the basis in bull market. Shorting basis can make profit if and only if when whole market crushed. Thus, we would pay more attention to long the basis. 

## How does the market changes affect the basis trading return?
The main idea of our trading strategy is to find the right time to open the basis trading position. We explore basis trading return from three different aspects: Market Emotion, History Basis and Volatility. 

### Market emotion
Use fear-and-greed index to describe the Market emotion

The fear-and-greed index was produced by analyzing the current sentiment of the Bitcoin market and crunch the numbers into a simple meter from 0 to 100. Zero means "Extreme Fear", while 100 means "Extreme Greed". 
#### Fear index vs Funding rate
```{r}
df <- read.csv('./preprocess//funding_fear.csv')
ggplot(df, aes(x=fear, y=fundingRate)) +
  geom_point() + geom_smooth(formula = y ~ x, method=lm) +
  xlab('Fear index') + ylab("Average funding rate")

```
In the figure, the x-axis is the value of fear index, the y-axis is the average funding rate group by fear index. There are more than 480 samples in data set. R-square is more 7.7 and the figure shows the strong linear relationship between fear index and funding rate. 

Thus, we can tell that there is strong positive correlation between fear index and funding rate.

In extreme fear market(fear index < 30), the average funding rate in 40 days is around 0. Thus, we will assume the funding rate is around 0 in fear market. 

#### Fear index vs return per risk
Plotting the fear index vs return per risk

Longing the basis when the current basis is positive, the known risk is the current basis and the unknown risk is the future funding rate. Based on pre_calculation, the funding rate is nearly zero in fear market. Thus, the main risk on basis trading is the basis. The pleasant time to open the position is low basis and high final return.

Thus, we use return_per_risk = "final return" / "basis", if final_return < 0, then final_return = 0 
```{r}
df <- read.csv('./preprocess//bear_basis.csv')
df2 <- read.csv('./preprocess//bull_basis.csv')
df$date = as.Date(df$date)
df2$date = as.Date(df2$date)
df$re_fear = df$fear /10
df2$re_fear = df2$fear / 10

df$return = (df$accumulation_funding_rate*100 - df$basis)
df2$return = (df2$accumulation_funding_rate*100 - df2$basis)
df$return[df$return < 0] = 0
df2$return[df2$return < 0] = 0

df$return_per_risk = (df$return*100) /  df$basis
df2$return_per_risk = (df2$return*100) / df2$basis
# 
F1 <- ggplot(df) +
  geom_point(aes(x = fear, y = return_per_risk ), size = 1) +ggtitle("Bear Market")

F2 <- ggplot(df2) +
  geom_point(aes(x = fear, y = return_per_risk ), size = 1) +ggtitle("Bull Market")

multiplot(F1, F2, cols = 1)
```
The figure is not that so persuasive, but we still can see that in bull market, the lower fear index, the higher return per risk. 


### Volatility vs Trading Return

Volatility is the degree of variation of a trading price series over time. We assume when the volatility is extreme high, many position in crypto market would be liquidated which would lead to extreme basis. 

```{r}
F1 <- ggplot(df) +
  geom_point(aes(x = Volatility, y = return_per_risk ), size = 1) +ggtitle("Bear Market")

F2 <- ggplot(df2) +
  geom_point(aes(x = Volatility, y = return_per_risk ), size = 1) +ggtitle("Bull Market")

multiplot(F1, F2, cols = 1)

```
From the figure, we can see that in the bull market, lower the volatility represents higher return per risk. It appeared might because the volatility is from the sudden increase of the price.


### Anuual basis vs return per risk

Anuual basis was designed to eliminate the effect of expiration date

Anuual basis = basis / remain date * 365

```{r}
F1 <- ggplot(df) +
  geom_point(aes(x = annual_basis, y = return_per_risk ), size = 1) +ggtitle("Bear Market")

F2 <- ggplot(df2) +
  geom_point(aes(x = annual_basis, y = return_per_risk ), size = 1) +ggtitle("Bull Market")

multiplot(F1, F2, cols = 1)

```


The annual basis seems a good estimator of the return per risk. From the figure we can see, when the annual basis is very small, basis trading can get high return per risk even in bear market. 

